<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta charset="utf-8">

  <!-- Page Info -->
  <link rel="shortcut icon" href="/assets/img/Armada-favicon.png">
  <title>System overview – Armada Project</title>
  <meta name="description" content="">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title"
    content="System overview – Armada Project">
  <meta name="twitter:description" content="">
  <meta name="twitter:image:src" content="">

  <!-- Facebook OpenGraph -->
  <meta property="og:title"
    content="System overview – Armada Project" />
  <meta property="og:description" content="" />
  <meta property="og:image" content="" />

  <!--  Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <!-- Nucleo Icons -->
  <link href="/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <link href="/assets/css/font-awesome.css" rel="stylesheet" />
  <link href="/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link rel="stylesheet" href="/assets/styles/styles.css" rel="stylesheet">

  
  <!-- Analytics Code -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id= G-SKPDW30VNF"></script>
  <script>
    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    gtag('js', new Date());

    gtag('config', ' G-SKPDW30VNF');
  </script>
  

  

</head>

<body>
  
    <nav id="navbar-main" class="navbar navbar-main navbar-expand-lg bg-default navbar-dark headroom">
      

        <div class="container">
          
          <a href="/" class="navbar-brand mr-lg-5">
            <img src="/assets/img/brand/Armada-white-rectangle.png">
          </a>
          

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_global"
            aria-controls="navbar_global" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="navbar-collapse collapse" id="navbar_global">
            <div class="navbar-collapse-header">
              <div class="row">
                <div class="col-6 collapse-brand">
                  
                  <a href="/">
                    <img src="/assets/img/brand/Armada-dark-rectangle.png">
                  </a>
                  
                </div>
                <div class="col-6 collapse-close">
                  <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar_global"
                    aria-controls="navbar_global" aria-expanded="false" aria-label="Toggle navigation">
                    <span></span>
                    <span></span>
                  </button>
                </div>
              </div>
            </div>
            <ul class="navbar-nav navbar-nav-hover align-items-lg-center ml-lg-auto">
              
                
                  <li class="nav-item">
                    <a href="/design" class="nav-link">
                      <span class="nav-link-inner--text">Design</span>
                    </a>
                  </li>
                
              
                
                  <li class="nav-item dropdown">
                    <a href="javascript:;" class="nav-link" data-toggle="dropdown" role="button">
                      <span class="nav-link-inner--text">Documentation</span>
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                      
                      <a class="dropdown-item" href="/developer">
                        <i class="ni "></i>
                        Development
                      </a>
                      
                      <a class="dropdown-item" href="/user">
                        <i class="ni "></i>
                        User Guide
                      </a>
                      
                      <a class="dropdown-item" href="/production-install">
                        <i class="ni "></i>
                        Production Install
                      </a>
                      
                    </div>
                  </li>
                
              
                
                  <li class="nav-item">
                    <a href="/quickstart" class="nav-link">
                      <span class="nav-link-inner--text">Quickstart</span>
                    </a>
                  </li>
                
              
                
                  <li class="nav-item">
                    <a href="/contribute" class="nav-link">
                      <span class="nav-link-inner--text">Contribute</span>
                    </a>
                  </li>
                
              
              <li class="nav-item github-logo-header desktop"><a class="" href="https://github.com/G-Research/armada" target="_blank">
                <img src="/assets/img/brand/GitHub-Mark-Light-120px-plus.png" width="40" height="40"></a>
              </li>
              <li class="nav-item mobile">
                <a href="https://github.com/G-Research/armada" class="nav-link" target="_blank">
                  <span class="nav-link-inner--text">Github</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
  <div class="wrapper page">
    
    <!-- Is not a blog post or blog archive or contact page -->
    <!-- Is a page with a banner -->
    <div class="page-header page-header-small header-filter mb-4">
      <div class="page-header-image card-background"
        style="background-image: url(/assets/img/ill/bg_contactus3.svg);"></div>
      <div class="container contentWrapper">
        <div class="row">
          <div class="col-lg-10 mx-auto text-center pt-4">
            <h2 class="display-2 text-white">System overview</h2>
            <h2 class="lead text-white pl-5 pr-5 pb-3 text-center"></h2>
          </div>
        </div>
      </div>
    </div>
    


    <div id="main" class="container">
      <h1 id="system-overview">System overview</h1>

<p>This document is meant to be an overview of Armada for new users. We cover the architecture of Armada, show how jobs are represented, and explain how jobs are queued and scheduled.</p>

<p>If you just want to learn how to submit jobs to Armada, see:</p>

<ul>
  <li><a href="/user.html">User guide</a></li>
</ul>

<h2 id="architecture">Architecture</h2>

<p>Armada consists of two main components:</p>
<ul>
  <li>The Armada server, which is responsible for accepting jobs from users and deciding in what order, and on which Kubernetes cluster, jobs should run. Users submit jobs to the Armada server through the <code class="language-plaintext highlighter-rouge">armadactl</code> command-line utility or via a gRPC or REST API.</li>
  <li>The Armada executor, of which there is one instance running in each Kubernetes cluster that Armada is connected to. Each Armada executor instance regularly notifies the server of how much spare capacity it has available and requests jobs to run. Users of Armada never interact with the executor directly.</li>
</ul>

<p>All state relating to the Armada server is stored in <a href="https://redis.io/">Redis</a>, which may use replication combined with failover for redundancy. Hence, the Armada server is itself stateless and is easily replicated by running multiple independent instances. Both the server and the executors are intended to be run in Kubernetes pods. We show a diagram of the architecture below.</p>

<p><img src="./batch-api.svg" alt="How Armada works" /></p>

<h3 id="job-leasing">Job leasing</h3>

<p>To avoid jobs being lost if a cluster (or cluster executor) becomes unavailable, each job assigned to an executor has an associated timeout. Armada executors are required to check in with the server regularly and, if an executor responsible for running a particular job fails to check in within that timeout, the server will re-schedule the job over another executor.</p>

<h2 id="jobs-and-job-sets">Jobs and job sets</h2>

<p>A job is the most basic unit of work in Armada, and is represented by a Kubernetes pod specification (podspec) with additional metadata specific to Armada. Armada handles creating, running, and removing containers as necessary for each job. Hence, Armada is essentially a system for managing the life cycle of a set of containerised applications representing a batch job.</p>

<p>The Armada workflow is:</p>

<ol>
  <li>Create a job specification, which is a Kubernetes podspec with a few additional metadata fields.</li>
  <li>Submit the job specification to one of Armada’s job queues using the <code class="language-plaintext highlighter-rouge">armadactl</code> CLI utility or through the Armada gRPC or REST API.</li>
</ol>

<p>For example, a job that sleeps for 60 seconds could be represented by the following yaml file.</p>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">queue</span><span class="pi">:</span> <span class="s">test</span>
<span class="na">jobSetId</span><span class="pi">:</span> <span class="s">set1</span>
<span class="na">jobs</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="na">priority</span><span class="pi">:</span> <span class="m">0</span>
    <span class="na">podSpecs</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">terminationGracePeriodSeconds</span><span class="pi">:</span> <span class="m">0</span>
        <span class="na">restartPolicy</span><span class="pi">:</span> <span class="s">Never</span>
        <span class="na">containers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">sleep</span>
            <span class="na">imagePullPolicy</span><span class="pi">:</span> <span class="s">IfNotPresent</span>
            <span class="na">image</span><span class="pi">:</span> <span class="s">busybox:latest</span>
            <span class="na">args</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="s">sleep</span>
              <span class="pi">-</span> <span class="s">60s</span>
            <span class="na">resources</span><span class="pi">:</span>
              <span class="na">limits</span><span class="pi">:</span>
                <span class="na">memory</span><span class="pi">:</span> <span class="s">64Mi</span>
                <span class="na">cpu</span><span class="pi">:</span> <span class="s">150m</span>
              <span class="na">requests</span><span class="pi">:</span>
                <span class="na">memory</span><span class="pi">:</span> <span class="s">64Mi</span>
                <span class="na">cpu</span><span class="pi">:</span> <span class="s">150m</span>
</code></pre></div></div>

<p>In the above yaml snippet, <code class="language-plaintext highlighter-rouge">podSpec</code> is a Kubernetes podspec, which consists of one or more containers that contain the user code to be run. In addition, the job specification (jobspec) contains metadata fields specific to Armada:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">queue</code>: which of the available job queues the job should be submitted to.</li>
  <li><code class="language-plaintext highlighter-rouge">priority</code>: the job priority (lower values indicate higher priority).</li>
  <li><code class="language-plaintext highlighter-rouge">jobSetId</code>: jobs with the same <code class="language-plaintext highlighter-rouge">jobSetId</code> can be followed and cancelled in a single operation. The <code class="language-plaintext highlighter-rouge">jobSetId</code> has no impact on scheduling.</li>
</ul>

<p>Queues and scheduling is explained in more detail below.</p>

<p>For more examples, including of jobs spanning multiple nodes, see the <a href="/user.html">user guide</a>.</p>

<h3 id="job-events">Job events</h3>

<p>A job event is generated whenever the state of a job changes (e.g., when changing from submitted to running or from running to completed) and is a timestamped message containing event-specific information (e.g., an exit code for a completed job). All events generated by jobs part of the same job set are grouped together and published via a <a href="https://redis.io/topics/streams-intro">Redis stream</a>. There are unique streams for each job set to facilitate subscribing only to events generated by jobs in a particular set, which can be done via the Armada API.</p>

<p>Armada records all events necessary to reconstruct the state of each job and, after a job has been completed,  the only information retained about the job is the events generated by it.</p>

<h2 id="queues-and-scheduling">Queues and scheduling</h2>

<p>An Armada cluster is configured with one or more queues, to which jobs may be submitted. For example, each user, team, or project may be given separate queues. Armada makes a scheduling decision whenever one of the executors residing in one of the underlying Kubernetes notifies the Armada server that it has unused resources available.</p>

<p>Both jobs and queues have a priority factor associated with it, and jobs are scheduled according to the following principles:</p>

<ul>
  <li>The fraction of resources assigned to each queue is proportional to the inverse of its priority factor. For example, if there are two queues with priority 1 and 2, respectively, the first queue will, on average, be assigned a fraction 1/3 of resources and the second a fraction 2/3 of resources.</li>
  <li>Within each queue, jobs with higher priority (i.e., with a lower priority factor) are scheduled before lower-priority jobs (i.e., with a higher priority factor), provided there are sufficient available resources in one of the Kubernetes clusters to run the higher-priority job.</li>
</ul>

<p>Note that lower-priority jobs may be scheduled before higher-priority jobs if there are insufficient resources to run the high-priority job and the lower-priority job requires fewer resources.</p>

<h3 id="queue-resource-usage-and-priority">Queue resource usage and priority</h3>

<p>Whenever the Armada server is about to make a scheduling decision, it first prioritises each queue based on its current overall resource usage and the priority factor associated with the queue. For each queue, its overall resource usage is computed as a weighted sum of the amount of each available resource, e.g., CPU, GPU, and memory, currently allocated to jobs originating from that queue. The weight for each resource type is equal to the amount of that resource type per CPU.</p>

<p>For example, if a cluster has 10 CPUs, 5 GPUs, and 20Gb of memory, the weights are:</p>

<ul>
  <li>GPU weight: <code class="language-plaintext highlighter-rouge">5 / 10 = 0.5</code></li>
  <li>Memory weight: <code class="language-plaintext highlighter-rouge">20 / 10 = 2</code></li>
</ul>

<p>CPU always has weight <code class="language-plaintext highlighter-rouge">1</code>.</p>

<p>Now, if the total resource usage by jobs originating from a particular queue is 5 CPU, 1 GPU, and 2 Gb memory, then the overall resource usage of the queue is:</p>

<p><code class="language-plaintext highlighter-rouge">5 / 1 + 1/ 0.5 + 2 / 2 = 8</code></p>

<p>Note that this system extends to resource types other than CPU, GPU, and memory.</p>

<p>After computing the overall resource usage of each queue, the Armada server updates the priority of each queue as follows (inspired by HTCondor):</p>

<p><code class="language-plaintext highlighter-rouge">priority = priority (1 - beta) + resourceUsage * beta</code>,</p>

<p>where</p>

<p><code class="language-plaintext highlighter-rouge">beta = 0.5 ^ (timeChange / priorityHalftime)</code>,</p>

<p><code class="language-plaintext highlighter-rouge">resourceUsage</code> is the current overall resource usage of the queue, <code class="language-plaintext highlighter-rouge">priorityHalftime</code> is a parameter that controls how quickly the priority converges to the current resource usage of the queue, and <code class="language-plaintext highlighter-rouge">timeChange</code> is the time since the priority was last updated. Hence, if the resource usage of all queues is constant, the priority of each queue will eventually converge to the resource usage of each queue.</p>

<p>Next, Armada computes the effective priority of each queue by multiplying the priority computed above by the priority factor associated with each queue, i.e.,</p>

<p><code class="language-plaintext highlighter-rouge">effectivePriority = priority * priorityFactor</code>.</p>

<p>Finally, Armade uses the effective priority to decide how to allocate available resources.</p>

<h3 id="scheduling-algorithm">Scheduling algorithm</h3>

<p>After computing the effective priority of all queues, Armada attempts to divide the available resources over non-empty queues according to their priority. This process consists of a deterministic stage followed by a probabilistic stage. The deterministic stage can be skipped entirely by configuring the Armada server with <code class="language-plaintext highlighter-rouge">scheduling.useProbabilisticSchedulingForAllResources = true</code>.</p>

<h4 id="deterministic-stage">Deterministic stage</h4>

<p>First, Armada divides all available resources over the non-empty queues such that the fraction of resources assigned to each non-empty queue is proportional to its effective priority. For example, if there are two queues with effective priority <code class="language-plaintext highlighter-rouge">1</code> and <code class="language-plaintext highlighter-rouge">2</code>, then those queues are assigned a fraction <code class="language-plaintext highlighter-rouge">1/3</code> and <code class="language-plaintext highlighter-rouge">2/3</code> of each resource, respectively. We refer to the per-queue resource allocation as the resource quota of the queue.</p>

<p>Next, Armada schedules jobs to run from each queue until there are no more jobs that can be scheduled without exceeding the resources quotas. For each queue, Armada first attempts to schedule the highest-priority job (i.e., the job with lowest priority factor). If scheduling the highest-priority job would exceed the resource quota of the queue, Armada moves down the list, attempting to schedule the second-highest priority job and so on. This process is repeated at most <code class="language-plaintext highlighter-rouge">queueLeaseBatchSize</code> times. Lower <code class="language-plaintext highlighter-rouge">queueLeaseBatchSize</code> speeds up scheduling at the expense of potentially missing jobs further down the queue that would have fit within the quota.</p>

<h4 id="probabilistic-stage">Probabilistic stage</h4>

<p>Whatever resources remain after the deterministic stage are scheduled using probabilistic slicing, which works as follows.</p>

<p>Armada randomly selects a non-empty queue with probability distribution corresponding to the remainders of queue slices. One job from this queue is scheduled, and the queue slice is reduced. This process is repeated until there is are no resources available, all queues are empty, or a time limit has been exceeded.</p>

<p>Note that there is a chance than one queue will get allocated more than it is entitled to. However, the average resource usage of each queue over a sufficiently large number of jobs will be close to the priority factor of the queue.</p>

<h3 id="permissions">Permissions</h3>

<p>Armada allows for setting user and group permissions for each queue via the <code class="language-plaintext highlighter-rouge">owners</code> and <code class="language-plaintext highlighter-rouge">groupOwners</code> options, respectively.
More granular permissions can also be used on a global or per-queue basis to determine which actions can be taken by users.
For more information, see the <a href="/api.html">Armada API docs</a>.</p>

<p>If the <code class="language-plaintext highlighter-rouge">kubernetes.impersonateUsers</code> flag is set, Armada will create pods in Kubernetes under the username of the job owner, which will enforce Kubernetes permissions and limit access to namespaces.</p>

<h3 id="resource-limits">Resource limits</h3>

<p>Each queue can have resource limits associated with it, which limit the resources consumed by the jobs from the queue to some percentage of all available resources at each point of time. For example, this prevents users from submitting long-running jobs during a period with low utilization that consume all resources in the cluster.</p>

    </div>
  </div>


  <footer class="footer mt-5 pt-4">
  <div class="container">
    <div class="row row-grid align-items-center mb-2 mt-2">
      <div class="col-lg-6">
        <h4 class="mb-0 font-weight-light">Armada Project</h4>
      </div>
      <div class="col-lg-6 text-lg-right">
        
    

    
    <button onclick="location.href='https://github.com/G-Research/armada/discussions';" rel="nofollow" class="btn btn-icon-only btn-discussions rounded-circle" data-toggle="tooltip" data-original-title="Discussions">
        <span class="btn-inner--icon">
            <i class="fab fa-discussions" aria-hidden="true"></i>
        </span>
    </button>
    

    
    <button onclick="location.href='https://twitter.com/GRESEARCHjobs';" rel="nofollow" class="btn btn-icon-only btn-twitter rounded-circle" data-toggle="tooltip" data-original-title="Twitter">
        <span class="btn-inner--icon">
            <i class="fab fa-twitter" aria-hidden="true"></i>
        </span>
    </button>
    

    

    

    

    

    

    

    

    
    <button onclick="location.href='https://github.com/G-Research/armada';" rel="nofollow" class="btn btn-icon-only btn-github rounded-circle" data-toggle="tooltip" data-original-title="Github">
        <span class="btn-inner--icon">
            <i class="fab fa-github" aria-hidden="true"></i>
        </span>
    </button>
    

    

    

      </div>
    </div>
    <hr>
    <div class="row align-items-center justify-content-md-between">
      <div class="col-md-6">
        <div class="copyright">
          <span> © 2022 Armada Project</span>
        </div>
      </div>
      <div class="col-md-6">
        <ul class="nav nav-footer justify-content-end">
          
          
          <li class="nav-item">
            <a href="/design" class="nav-link">
              <span class="nav-link-inner--text">Design</span>
            </a>
          </li>
          
          
          
          <li class="nav-item">
            <a href="" class="nav-link">
              <span class="nav-link-inner--text">Documentation</span>
            </a>
          </li>

          
          
          
          <li class="nav-item">
            <a href="/quickstart" class="nav-link">
              <span class="nav-link-inner--text">Quickstart</span>
            </a>
          </li>
          
          
          
          <li class="nav-item">
            <a href="/contribute" class="nav-link">
              <span class="nav-link-inner--text">Contribute</span>
            </a>
          </li>
          
          
        </ul>
      </div>
    </div>
  </div>
</footer>



<!--   Core JS Files   -->
<script src="/assets/js/core/jquery.min.js" type="text/javascript"></script>
<script src="/assets/js/core/popper.min.js" type="text/javascript"></script>
<script src="/assets/js/core/bootstrap.min.js" type="text/javascript"></script>
<script src="/assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
<!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
<script src="/assets/js/plugins/bootstrap-switch.js"></script>
<!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
<script src="/assets/js/plugins/nouislider.min.js" type="text/javascript"></script>
<!--  Plugin for the Carousel, full documentation here: http://jedrzejchalubek.com/ -->
<script src="/assets/js/plugins/glide.js" type="text/javascript"></script>
<!--  Plugin for the DatePicker, full documentation here: https://flatpickr.js.org/ -->
<script src="/assets/js/plugins/moment.min.js"></script>
<!--	Plugin for Select, full documentation here: https://joshuajohnson.co.uk/Choices/ -->
<script src="/assets/js/plugins/choices.min.js" type="text/javascript"></script>
<!--  Plugin for the DateTimePicker, full documentation here: https://flatpickr.js.org/ -->
<script src="/assets/js/plugins/datetimepicker.js" type="text/javascript"></script>
<!-- Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
<script src="/assets/js/plugins/jasny-bootstrap.min.js"></script>
<!-- Plugin for Headrom, full documentation here: https://wicky.nillia.ms/headroom.js/ -->
<script src="/assets/js/plugins/headroom.min.js"></script>
<!-- Control Center for Argon UI Kit: parallax effects, scripts for the example pages etc -->

<script>
  // Blog Post Carousel
  if (document.querySelector('.blogGlide') !== null) {
    new Glide('.blogGlide', {
      type: 'carousel',
      startAt: 0,
      focusAt: 2,
      perTouch: 1,
      perView: 4
    }).mount();
  }

  if (document.querySelector('.glide') !== null) {
    // Generic
     new Glide('.glide', {
      type: 'carousel',
      startAt: 0,
      focusAt: 2,
      perTouch: 1,
      perView: 4
    }).mount();
  }

  if (document.querySelector('.testimonial-glide') !== null) {
    // Testimonial Carousel
    new Glide('.testimonial-glide', {
      type: 'carousel',
      startAt: 0,
      focusAt: 2,
      perTouch: 1,
      perView: 4
    }).mount();
  }

</script>

<script>
  $(function () {
    var navOffset = $('#navbar-main').height();
    $('.contentWrapper').css('padding-top', navOffset * 2 + 'px');
  });    
</script>



<script src="/assets/js/argon-design-system.min.js?v=1.0.0" type="text/javascript"></script>

  

</body>

</html>
</body>

</html>
