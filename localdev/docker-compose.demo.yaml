version: "3.8"

networks:
  kind:
    external: true

services:
  #
  # Infrastructure services.
  # A Kubernetes cluster (e.g., kind) must also be setup before starting Armada.
  #
  redis:
    container_name: redis
    image: redis
    ports:
      - "6379:6379"
    networks:
      - kind

  postgres:
    container_name: postgres
    image: postgres
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=psw
    volumes:
      - ./scripts/postgres-init.sh:/docker-entrypoint-initdb.d/init-database.sh
    ports:
      - "5432:5432"
    networks:
      - kind

  pulsar:
    image: ${PULSAR_IMAGE:-apachepulsar/pulsar:2.10.0}
    container_name: pulsar
    volumes:
      - ./pulsar.conf:/conf/pulsar.conf
    entrypoint: bin/pulsar standalone
    ports:
      - "0.0.0.0:6650:6650"
    networks:
      - kind

  #
  # Armada services.
  #
  server:
    container_name: server
    image: sharp6292/armada-demo:latest
    networks:
      - kind
    ports:
      - 50051:50051
      - 8080:8080
    volumes:
      - ./config:/config
      - "..:/app:rw"
    depends_on:
      - redis
      - postgres
      - pulsar
    working_dir: /app
    command: /bin/server --config /config/armada/config.yaml

  lookout:
    container_name: lookout
    image: sharp6292/armada-demo:latest
    networks:
      - kind
    ports:
      - "8089:8089"
    volumes:
      - ./config:/config
      - "..:/app:rw"
    depends_on:
      - postgres
      - server
      - lookout-ingester
    working_dir: "/app"
    command: sh -c "/bin/lookout --config /config/lookout/config.yaml --migrateDatabase && /bin/lookout --config /config/lookout/config.yaml --lookoutUI /bin/lookoutui"

  lookoutv2:
    container_name: lookoutv2
    image: sharp6292/armada-demo:latest
    networks:
      - kind
    ports:
      - "10000:10000"
    volumes:
      - ./config:/config
      - "..:/app:rw"
    depends_on:
      - postgres
      - server
      - lookout-ingesterv2
    working_dir: "/app"
    command: sh -c "/bin/lookoutv2 --config /config/lookoutv2/config.yaml --migrateDatabase && /bin/lookoutv2 --config /config/lookoutv2/config.yaml"

  executor:
    container_name: executor
    image: sharp6292/armada-demo:latest
    networks:
      - kind
    ports:
      - 9001:9001
    depends_on:
      - server
    volumes:
      - ./config:/config
      - ./.kube:/.kube
      - "..:/app:rw"
    environment:
      - KUBECONFIG=/.kube/config
    working_dir: /app
    command: /bin/executor --config /config/executor/config.yaml

  binoculars:
    container_name: binoculars
    image: sharp6292/armada-demo:latest
    networks:
      - kind
    ports:
      - 8082:8082
    depends_on:
      - server
    volumes:
      - ./config:/config
      - ./.kube:/.kube
      - "..:/app:rw"
    environment:
      - KUBECONFIG=/.kube/config
    working_dir: /app
    command: /bin/binoculars --config /config/binoculars/config.yaml

  jobservice:
    container_name: jobservice
    image: sharp6292/armada-demo:latest
    networks:
      - kind
    ports:
      - 60003:60003
    depends_on:
      - server
    volumes:
      - ./config:/config
      - "..:/app:rw"
    working_dir: "/app"
    command: /bin/jobservice run --config /config/jobservice/config.yaml

  lookout-ingester:
    container_name: lookout-ingester
    image: sharp6292/armada-demo:latest
    networks:
      - kind
    depends_on:
      - postgres
    volumes:
      - ./config:/config
      - "..:/app:rw"
    working_dir: /app
    command: /bin/lookoutingester --config /config/lookoutingester/config.yaml

  lookout-ingesterv2:
    container_name: lookout-ingesterv2
    image: sharp6292/armada-demo:latest
    networks:
      - kind
    depends_on:
      - postgres
    volumes:
      - ./config:/config
      - "..:/app:rw"
    working_dir: /app
    command: /bin/lookoutingesterv2 --config /config/lookoutingesterv2/config.yaml

  event-ingester:
    container_name: event-ingester
    image: sharp6292/armada-demo:latest
    networks:
      - kind
    depends_on:
      - redis
    volumes:
      - ./config:/config
      - "..:/app:rw"
    working_dir: /app
    command: /bin/eventingester --config /config/eventingester/config.yaml