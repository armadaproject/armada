name: Code Coverage

on:
  push:
  pull_request:

jobs:
  go-unit-coverage:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        go: [ '1.18' ]

    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/workflows/go-setup

      - name: make tests
        run: make tests

      - name: Go Test Coverage
        uses: codecov/codecov-action@v3
        with:
          files: ./internal_coverage.xml,./cmd_coverage.xml # optional
          flags: armada-server

  python-unit-coverage:
    runs-on: ubuntu-22.04
    strategy:
      fail-fast: false
      matrix:
        python: [ '3.10' ]

    steps:
      - uses: actions/checkout@v3
      - uses: ./.github/workflows/python-setup

      # Tox to run tests; build to build the wheel after tests pass
      - run: pip install tox==3.27.1 build twine
        shell: bash

      # Generate the proto files for python, required for later steps
      - run: make python airflow-operator
        shell: bash

      - name: Coverage for Python Client
        run: tox -e py310
        shell: bash
        working-directory: ./client/python

      - name: Coverage for Airflow Operator
        run: tox -e py310
        shell: bash
        working-directory: ./third_party/airflow

      - name: Upload Python Client Coverage to codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./client/python/coverage.xml
          flags: python-client

      - name: Upload Airflow Operator Coverage to codecov
        uses: codecov/codecov-action@v3
        with:
          files: ./third_party/airflow/coverage.xml
          flags: airflow-operator