name: "Lint"

on:
  pull_request:
    types:
      - opened
      - edited
      - synchronize

permissions:
  contents: read

jobs:
  lint-proto:
    name: Lint proto
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Lint using protolint
        uses: plexsystems/protolint-action@v0.7.0
        with:
          configDirectory: .
          srcDirectory: pkg

  lint-docs:
    name: Lint docs
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Lint changelog file
        uses: avto-dev/markdown-lint@v1
        with:
          args: './docs'

  lint-go:
    name: Lint Go
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Set up Go
        uses: actions/setup-go@v3
        with:
          go-version: 1.18
          cache: true

      - name: Lint using golangci-lint
        uses: golangci/golangci-lint-action@v3
        with:
          version: latest
          skip-pkg-cache: true
          skip-build-cache: true
          args: --timeout=10m --issues-exit-code=1 --sort-results ./...

  lint-helm:
    name: Lint Helm
    runs-on: ubuntu-22.04

    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Lint Server Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/armada
          CHART_VALUES: ./deployment/armada/values.yaml

      - name: Lint Bundle Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/armada-bundle
          CHART_VALUES: ./deployment/armada-bundle/values.yaml

      - name: Lint Binoculars Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/binoculars
          CHART_VALUES: ./deployment/binoculars/values.yaml

      - name: Lint Server Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/armada
          CHART_VALUES: ./deployment/armada/values.yaml

      - name: Lint Event Ingester Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/event-ingester
          CHART_VALUES: ./deployment/event-ingester/values.yaml

      - name: Lint Executor Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/executor
          CHART_VALUES: ./deployment/executor/values.yaml

      - name: Lint Executor Cluster Monitoring Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/executor-cluster-monitoring
          CHART_VALUES: ./deployment/executor-cluster-monitoring/values.yaml

      - name: Lint Job Service Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/jobservice
          CHART_VALUES: ./deployment/jobservice/values.yaml

      - name: Lint Lookout Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/lookout
          CHART_VALUES: ./deployment/lookout/values.yaml

      - name: Lint Lookout Ingester Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/lookout-ingester
          CHART_VALUES: ./deployment/lookout-ingester/values.yaml

      - name: Lint Lookout Ingester v2 Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/lookout-ingester-v2
          CHART_VALUES: ./deployment/lookout-ingester-v2/values.yaml

      - name: Lint Lookout Migration Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/lookout-migration
          CHART_VALUES: ./deployment/lookout-migration/values.yaml

      - name: Lint Lookout Migration v2 Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/lookout-migration-v2
          CHART_VALUES: ./deployment/lookout-migration-v2/values.yaml

      - name: Lint Lookout v2 Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/lookout-v2
          CHART_VALUES: ./deployment/lookout-v2/values.yaml

      - name: Lint Scheduler Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/scheduler
          CHART_VALUES: ./deployment/scheduler/values.yaml

      - name: Lint Scheduler Migration Helm Chart
        if: always()
        uses: hopisaurus/helm-check-action@v0.1.1
        env:
          CHART_LOCATION: ./deployment/scheduler-migration
          CHART_VALUES: ./deployment/scheduler-migration/values.yaml

lint-docker:
  name: Lint Docker
  runs-on: ubuntu-22.04

  steps:
    - name: Checkout
      uses: actions/checkout@v3

    - name: Lint ArmadaCtl Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/armadactl/Dockerfile

    - name: Lint Binoculars Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/binoculars/Dockerfile

    - name: Lint Event Ingester Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/event-ingester/Dockerfile

    - name: Lint Executor Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/executor/Dockerfile

    - name: Lint Fake Executor Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/fakeexecutor/Dockerfile

    - name: Lint Job Service Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/jobservice/Dockerfile

    - name: Lint Lookout Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/lookout/Dockerfile

    - name: Lint Lookout Ingester Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/lookout-ingester/Dockerfile

    - name: Lint Lookout Ingester v2 Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/lookout-ingester-v2/Dockerfile

    - name: Lint Lookout v2 Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/lookout-v2/Dockerfile

    - name: Lint Python Client Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/python-client/Dockerfile

    - name: Lint Scheduler Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/scheduler/Dockerfile

    - name: Lint Scheduler Ingester Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/scheduleringester/Dockerfile

    - name: Lint Testsuite Dockerfile
      uses: hadolint/hadolint-action@v3.1.0
      with:
        dockerfile: build/testsuite/Dockerfile

