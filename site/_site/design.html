<!DOCTYPE html>
<html lang="en-US">

<head>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta charset="utf-8">

  <!-- Page Info -->
  <link rel="shortcut icon" href="/assets/img/Armada-favicon.png">
  <title>Design – Armada Project</title>
  <meta name="description" content="">

  <!-- Twitter Card -->
  <meta name="twitter:card" content="summary_large_image">
  <meta name="twitter:title"
    content="Design – Armada Project">
  <meta name="twitter:description" content="">
  <meta name="twitter:image:src" content="http://localhost:4000/assets/img/ill/bg_contactus3.svg">

  <!-- Facebook OpenGraph -->
  <meta property="og:title"
    content="Design – Armada Project" />
  <meta property="og:description" content="" />
  <meta property="og:image" content="http://localhost:4000/assets/img/ill/bg_contactus3.svg" />

  <!--  Fonts and icons -->
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet">
  <link href="https://use.fontawesome.com/releases/v5.0.6/css/all.css" rel="stylesheet">
  <!-- Nucleo Icons -->
  <link href="/assets/css/nucleo-icons.css" rel="stylesheet" />
  <link href="/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- Font Awesome Icons -->
  <link href="/assets/css/font-awesome.css" rel="stylesheet" />
  <link href="/assets/css/nucleo-svg.css" rel="stylesheet" />
  <!-- CSS Files -->
  <link rel="stylesheet" href="/assets/styles/styles.css" rel="stylesheet">

  

  

</head>

<body>
  
<nav id="navbar-main" class="navbar navbar-main navbar-expand-lg navbar-transparent headroom">
  

        <div class="container">
          
          <a href="/" class="navbar-brand mr-lg-5">
            <img src="/assets/img/brand/Armada-white-rectangle.png">
          </a>
          

          <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbar_global"
            aria-controls="navbar_global" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
          </button>
          <div class="navbar-collapse collapse" id="navbar_global">
            <div class="navbar-collapse-header">
              <div class="row">
                <div class="col-6 collapse-brand">
                  
                  <a href="/">
                    <img src="/assets/img/brand/Armada-dark-rectangle.png">
                  </a>
                  
                </div>
                <div class="col-6 collapse-close">
                  <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbar_global"
                    aria-controls="navbar_global" aria-expanded="false" aria-label="Toggle navigation">
                    <span></span>
                    <span></span>
                  </button>
                </div>
              </div>
            </div>
            <ul class="navbar-nav navbar-nav-hover align-items-lg-center ml-lg-auto">
              
                
                  <li class="nav-item">
                    <a href="/design" class="nav-link">
                      <span class="nav-link-inner--text">Design</span>
                    </a>
                  </li>
                
              
                
                  <li class="nav-item dropdown">
                    <a href="javascript:;" class="nav-link" data-toggle="dropdown" role="button">
                      <span class="nav-link-inner--text">Documentation</span>
                    </a>
                    <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
                      
                      <a class="dropdown-item" href="/developer">
                        <i class="ni "></i>
                        Development
                      </a>
                      
                      <a class="dropdown-item" href="/user">
                        <i class="ni "></i>
                        User Guide
                      </a>
                      
                      <a class="dropdown-item" href="/production-install">
                        <i class="ni "></i>
                        Production Install
                      </a>
                      
                    </div>
                  </li>
                
              
                
                  <li class="nav-item">
                    <a href="/quickstart" class="nav-link">
                      <span class="nav-link-inner--text">Quickstart</span>
                    </a>
                  </li>
                
              
                
                  <li class="nav-item">
                    <a href="/contributing" class="nav-link">
                      <span class="nav-link-inner--text">Contribute</span>
                    </a>
                  </li>
                
              
              <li class="nav-item github-logo-header desktop"><a class="" href="https://github.com/G-Research/armada" target="_blank">
                <img src="/assets/img/brand/GitHub-Mark-Light-120px-plus.png" width="40" height="40"></a>
              </li>
              <li class="nav-item mobile">
                <a href="https://github.com/G-Research/armada" class="nav-link" target="_blank">
                  <span class="nav-link-inner--text">Github</span>
                </a>
              </li>
            </ul>
          </div>
        </div>
      </nav>
  <div class="wrapper page">
    
    <!-- Is not a blog post or blog archive or contact page -->
    
    <!-- Is a page with a banner -->
    <div class="page-header page-header-small header-filter mb-4">
      <div class="page-header-image card-background"
        style="background-image: url(/assets/img/ill/bg_contactus3.svg);"></div>
      <div class="container contentWrapper">
        <div class="row">
          <div class="col-lg-10 mx-auto text-center pt-4">
            <h2 class="display-2 text-white">Design</h2>
            <h2 class="lead text-white pl-5 pr-5 pb-3 text-center"></h2>
          </div>
        </div>
      </div>
    </div>
    
    

    <div id="main" class="container">
      <h1 id="high-level-design-of-armada">High level design of Armada</h1>
<p>Armada is job queueing system for multiple Kubernetes clusters.</p>

<h2 id="goals-for-the-project">Goals for the project</h2>
<ul>
  <li>Easily handle large queues of jobs (million +)</li>
  <li>Enforce fair share over time</li>
  <li>Failure of some worker clusters should not cause an outage</li>
  <li>Reasonable latency between job submission and job start when there is resource available (in order of 10s)</li>
  <li>Maximize utilization of the cluster</li>
  <li>Smart queueing instead of scheduler - implement only minimum logic needed on global level, let cluster scheduler do its own work.</li>
  <li>All components should be highly available</li>
</ul>

<h2 id="data-model">Data model</h2>
<h3 id="job">Job</h3>
<p>A Job is an executable unit, currently containing a Kubernetes pod specification.</p>

<h3 id="job-set">Job Set</h3>
<p>All jobs are grouped into Job Sets with user-specified identifier. A Job Set represents a project or other higher level unit of work. Users can observe events in Job Sets through the API.</p>

<h3 id="queue">Queue</h3>
<p>All jobs need to be placed into queues. Resources allocation is controlled using queues.</p>

<p><strong>Queue Current Priority</strong>: Current priority is calculated from resource usage of jobs in the queue. This number approaches the amount of resource used by the queue with configurable speed by <code class="language-plaintext highlighter-rouge">priorityHalfTime</code> configuration. If the queue priority is <code class="language-plaintext highlighter-rouge">A</code> and queue is using <code class="language-plaintext highlighter-rouge">B</code> amount of resource, after time defined by <code class="language-plaintext highlighter-rouge">priorityHalfTime</code> the new priority will be <code class="language-plaintext highlighter-rouge">A + (B - A) / 2</code>.</p>

<p><strong>Queue Priority Factor</strong>: Each queue has priority factor which determines how important the queue is (lower number makes queue more important).</p>

<p><strong>Queue Effective Priority</strong> = <strong>Queue Priority Factor</strong> * <strong>Queue Current Priority</strong></p>

<p>To achieve fairness between queues, when Armada schedules jobs resources are divided based on Queue Effective Priority.</p>

<p>More information about queue priority and scheduling can be found <a href="./priority.md">here</a></p>

<h2 id="design">Design</h2>
<p><img src="/assets/img/batch-api.svg" alt="Diagram" /></p>

<h3 id="armada-server">Armada Server</h3>
<p>The Armada Server is a central component which manages queues of jobs.
It stores all active jobs in the job database (current implementation use Redis).</p>

<h3 id="cluster-executor">Cluster Executor</h3>
<p>The Cluster Executor is a component running on each Kubernetes worker cluster. It keeps all pod and node information in memory and manages jobs within the cluster.
It proactively reports the current state of the cluster and asks for jobs to run.
Queue Usage is recorded in the database and is used to update priorities of individual queues.
The executor can also refuse to execute an assigned job and return it.</p>

<h4 id="job-leasing">Job Leasing</h4>
<p>Executors periodically ask the server for jobs to run, reporting available resources. Armada distributes these available resources among queues according to Queue Effective Priority. 
Jobs are taken from the top of each queue until the available resource is filled. These jobs are then returned to the executor to be executed on the cluster and marked as leased with a timestamp to show when the lease began.</p>

<p>The executor must regularly renew the lease of all jobs it leases, otherwise leases expire and jobs will be considered failed and executed on different cluster.</p>

<h4 id="job-events">Job Events</h4>
<p>Job events are used to show when a job reaches a new state, such as submitted, running, completed. They hold generic information about events (such as created-time) along with state specific information (such as exit-code for completed jobs).</p>

<p>Armada records events of all jobs against the job set the job belongs to. Events for a given job set are available through the API.</p>

<p>Armada records all necessary events to fully reconstruct state of the job at any time. This allows us to erase all job data from the jobs database after the job finishes and keep only the events.</p>

<p>The current implementation utilises Redis streams to store job events.</p>


    </div>
  </div>


  <footer class="footer mt-5 pt-4">
  <div class="container">
    <div class="row row-grid align-items-center mb-2 mt-2">
      <div class="col-lg-6">
        <h4 class="mb-0 font-weight-light">Armada Project</h4>
      </div>
      <div class="col-lg-6 text-lg-right">
        
    

    
    <button onclick="location.href='https://twitter.com/GRESEARCHjobs';" rel="nofollow" class="btn btn-icon-only btn-twitter rounded-circle" data-toggle="tooltip" data-original-title="Twitter">
        <span class="btn-inner--icon">
            <i class="fab fa-twitter" aria-hidden="true"></i>
        </span>
    </button>
    

    

    

    

    

    
    <button onclick="location.href='https://gitter.im/ArmadaProject/community';" rel="nofollow" class="btn btn-icon-only btn-gitter rounded-circle" data-toggle="tooltip" data-original-title="Gitter">
        <span class="btn-inner--icon">
            <i class="fab fa-gitter" aria-hidden="true"></i>
        </span>
    </button>
    

    

    

    
    <button onclick="location.href='https://github.com/G-Research/armada';" rel="nofollow" class="btn btn-icon-only btn-github rounded-circle" data-toggle="tooltip" data-original-title="Github">
        <span class="btn-inner--icon">
            <i class="fab fa-github" aria-hidden="true"></i>
        </span>
    </button>
    

    

    

      </div>
    </div>
    <hr>
    <div class="row align-items-center justify-content-md-between">
      <div class="col-md-6">
        <div class="copyright">
          <span> © 2020 Armada Project</span>
        </div>
      </div>
      <div class="col-md-6">
        <ul class="nav nav-footer justify-content-end">
          
          
          <li class="nav-item">
            <a href="/design" class="nav-link">
              <span class="nav-link-inner--text">Design</span>
            </a>
          </li>
          
          
          
          <li class="nav-item">
            <a href="" class="nav-link">
              <span class="nav-link-inner--text">Documentation</span>
            </a>
          </li>

          
          
          
          <li class="nav-item">
            <a href="/quickstart" class="nav-link">
              <span class="nav-link-inner--text">Quickstart</span>
            </a>
          </li>
          
          
          
          <li class="nav-item">
            <a href="/contributing" class="nav-link">
              <span class="nav-link-inner--text">Contribute</span>
            </a>
          </li>
          
          
        </ul>
      </div>
    </div>
  </div>
</footer>



<!--   Core JS Files   -->
<script src="/assets/js/core/jquery.min.js" type="text/javascript"></script>
<script src="/assets/js/core/popper.min.js" type="text/javascript"></script>
<script src="/assets/js/core/bootstrap.min.js" type="text/javascript"></script>
<script src="/assets/js/plugins/perfect-scrollbar.jquery.min.js"></script>
<!--  Plugin for Switches, full documentation here: http://www.jque.re/plugins/version3/bootstrap.switch/ -->
<script src="/assets/js/plugins/bootstrap-switch.js"></script>
<!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
<script src="/assets/js/plugins/nouislider.min.js" type="text/javascript"></script>
<!--  Plugin for the Carousel, full documentation here: http://jedrzejchalubek.com/ -->
<script src="/assets/js/plugins/glide.js" type="text/javascript"></script>
<!--  Plugin for the DatePicker, full documentation here: https://flatpickr.js.org/ -->
<script src="/assets/js/plugins/moment.min.js"></script>
<!--	Plugin for Select, full documentation here: https://joshuajohnson.co.uk/Choices/ -->
<script src="/assets/js/plugins/choices.min.js" type="text/javascript"></script>
<!--  Plugin for the DateTimePicker, full documentation here: https://flatpickr.js.org/ -->
<script src="/assets/js/plugins/datetimepicker.js" type="text/javascript"></script>
<!-- Plugin for Fileupload, full documentation here: http://www.jasny.net/bootstrap/javascript/#fileinput -->
<script src="/assets/js/plugins/jasny-bootstrap.min.js"></script>
<!-- Plugin for Headrom, full documentation here: https://wicky.nillia.ms/headroom.js/ -->
<script src="/assets/js/plugins/headroom.min.js"></script>
<!-- Control Center for Argon UI Kit: parallax effects, scripts for the example pages etc -->

<script>
  // Blog Post Carousel
  if (document.querySelector('.blogGlide') !== null) {
    new Glide('.blogGlide', {
      type: 'carousel',
      startAt: 0,
      focusAt: 2,
      perTouch: 1,
      perView: 4
    }).mount();
  }

  if (document.querySelector('.glide') !== null) {
    // Generic
     new Glide('.glide', {
      type: 'carousel',
      startAt: 0,
      focusAt: 2,
      perTouch: 1,
      perView: 4
    }).mount();
  }

  if (document.querySelector('.testimonial-glide') !== null) {
    // Testimonial Carousel
    new Glide('.testimonial-glide', {
      type: 'carousel',
      startAt: 0,
      focusAt: 2,
      perTouch: 1,
      perView: 4
    }).mount();
  }

</script>

<script>
  $(function () {
    var navOffset = $('#navbar-main').height();
    $('.contentWrapper').css('padding-top', navOffset * 2 + 'px');
  });    
</script>



<script src="/assets/js/argon-design-system.min.js?v=1.0.0" type="text/javascript"></script>

  

</body>

</html>
</body>

</html>