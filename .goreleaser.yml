project_name: armada

dist: "dist"

gomod:
  proxy: true
  env:
    - GOPROXY=https://proxy.golang.org,direct
    - GOSUMDB=sum.golang.org
  gobinary: go

builds:
  - env: [CGO_ENABLED=0]
    id: server
    binary: server
    main: ./cmd/armada/main.go
    mod_timestamp: '{{ .CommitTimestamp }}'
    goos:
      - linux
    goarch:
      - amd64
  - env: [CGO_ENABLED=0]
    id: executor
    binary: executor
    main: ./cmd/executor/main.go
    mod_timestamp: '{{ .CommitTimestamp }}'
    goos:
      - linux
    goarch:
      - amd64
  - env: [CGO_ENABLED=0]
    id: armadactl
    binary: armadactl
    main: ./cmd/armadactl/main.go
    mod_timestamp: '{{ .CommitTimestamp }}'
    goos:
      - windows
      - darwin
      - linux
    goarch:
      - amd64
      - arm64

archives:
  - id: armadactl
    builds:
      - armadactl
    allow_different_binary_count: true
    name_template: "armadactl_{{ .Version }}_{{ .Os }}_{{ .Arch }}"
    format_overrides:
      - goos: windows
        format: zip

# macOS Universal Binaries
universal_binaries:
  - replace: true
    id: armadactl
    name_template: 'armadactl'

signs:
  - artifacts: checksum

sboms:
  - artifacts: archive

dockers:
  -
    goos: linux
    goarch: amd64
    image_templates:
      - "{{ .Env.DOCKER_REPO }}/armada-server:{{ .Major }}"
      - "{{ .Env.DOCKER_REPO }}/armada-server:{{ .Major }}.{{ .Minor }}"
      - "{{ .Env.DOCKER_REPO }}/armada-server:{{ .Major }}.{{ .Minor }}.{{ .Patch }}"
      - "{{ .Env.DOCKER_REPO }}/armada-server:latest"
    build_flag_templates:
      - --label=org.opencontainers.image.title=armada-server
      - --label=org.opencontainers.image.description="Armada Server"
      - --label=org.opencontainers.image.url=https://hub.docker.com/r/gresearchdev/armada-server
      - --label=org.opencontainers.image.source=https://github.com/G-Research/armada
      - --label=org.opencontainers.image.version={{ .Version }}
      - --label=org.opencontainers.image.created={{ time "2006-01-02T15:04:05Z07:00" }}
      - --label=org.opencontainers.image.revision={{ .FullCommit }}
    extra_files:
      - config/armada/config.yaml
    dockerfile: ./build_goreleaser/server/Dockerfile
  -
    goos: linux
    goarch: amd64
    image_templates:
      - "{{ .Env.DOCKER_REPO }}/armada-executor:{{ .Major }}"
      - "{{ .Env.DOCKER_REPO }}/armada-executor:{{ .Major }}.{{ .Minor }}"
      - "{{ .Env.DOCKER_REPO }}/armada-executor:{{ .Major }}.{{ .Minor }}.{{ .Patch }}"
      - "{{ .Env.DOCKER_REPO }}/armada-executor:latest"
    build_flag_templates:
      - --label=org.opencontainers.image.title=armada-executor
      - --label=org.opencontainers.image.description="Armada Executor"
      - --label=org.opencontainers.image.url=https://hub.docker.com/r/gresearchdev/armada-executor
      - --label=org.opencontainers.image.source=https://github.com/G-Research/armada
      - --label=org.opencontainers.image.version={{ .Version }}
      - --label=org.opencontainers.image.created={{ time "2006-01-02T15:04:05Z07:00" }}
      - --label=org.opencontainers.image.revision={{ .FullCommit }}
    extra_files:
      - config/executor/config.yaml
    dockerfile: ./build_goreleaser/executor/Dockerfile
  -
    goos: linux
    goarch: amd64
    image_templates:
      - "{{ .Env.DOCKER_REPO }}/armadactl:{{ .Major }}"
      - "{{ .Env.DOCKER_REPO }}/armadactl:{{ .Major }}.{{ .Minor }}"
      - "{{ .Env.DOCKER_REPO }}/armadactl:{{ .Major }}.{{ .Minor }}.{{ .Patch }}"
      - "{{ .Env.DOCKER_REPO }}/armadactl:latest"
    build_flag_templates:
      - --label=org.opencontainers.image.title=armadactl
      - --label=org.opencontainers.image.description="Armada CLI"
      - --label=org.opencontainers.image.url=https://hub.docker.com/r/gresearchdev/armadactl
      - --label=org.opencontainers.image.source=https://github.com/G-Research/armada
      - --label=org.opencontainers.image.version={{ .Version }}
      - --label=org.opencontainers.image.created={{ time "2006-01-02T15:04:05Z07:00" }}
      - --label=org.opencontainers.image.revision={{ .FullCommit }}
    dockerfile: ./build_goreleaser/armadactl/Dockerfile

changelog:
  use: "github"

checksum:
  name_template: "checksums.txt"

release:
  draft: false
  header: |
    ## Armada {{ .Version }} - ({{ .Date }})
    See https://github.com/kubeshop/{{ .ProjectName }} for download links and documentation
    ## Docker images
    ### Armada Server
    - `docker pull {{ .Env.DOCKER_REPO }}/armada-server:{{ .Major }}`
    - `docker pull {{ .Env.DOCKER_REPO }}/armada-server:{{ .Major }}.{{ .Minor }}`
    - `docker pull {{ .Env.DOCKER_REPO }}/armada-server:{{ .Major }}.{{ .Minor }}.{{ .Patch }}`
    - `docker pull {{ .Env.DOCKER_REPO }}/armada-server:latest`
    ### Armada Executor
    - `docker pull {{ .Env.DOCKER_REPO }}/armada-executor:{{ .Major }}`
    - `docker pull {{ .Env.DOCKER_REPO }}/armada-executor:{{ .Major }}.{{ .Minor }}`
    - `docker pull {{ .Env.DOCKER_REPO }}/armada-executor:{{ .Major }}.{{ .Minor }}.{{ .Patch }}`
    - `docker pull {{ .Env.DOCKER_REPO }}/armada-executor:latest`
    ### Armada CLI
    - `docker pull {{ .Env.DOCKER_REPO }}/armadactl:{{ .Major }}`
    - `docker pull {{ .Env.DOCKER_REPO }}/armadactl:{{ .Major }}.{{ .Minor }}`
    - `docker pull {{ .Env.DOCKER_REPO }}/armadactl:{{ .Major }}.{{ .Minor }}.{{ .Patch }}`
    - `docker pull {{ .Env.DOCKER_REPO }}/armadactl:latest`

snapshot:
  name_template: "{{ .Tag }}"

source:
  enabled: true
  name_template: "{{ .ProjectName }}_{{ .Version }}_source"
  format: "zip"
